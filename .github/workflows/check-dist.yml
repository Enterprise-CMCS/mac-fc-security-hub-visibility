name: Check that module was built

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  check-dist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Save the dist/ directory before build
        run: |
          mkdir -p .git/previous-dist
          cp -r dist/* .git/previous-dist/

      - name: Build the dist/ directory
        run: npm run build

      - name: Show Folder Structure
        run: ls -R

      - name: Check for changes in dist/
        run: |
          # Check differences between current and previous dist/
          git diff --exit-code .git/previous-dist/ dist/
          exit_code=$?
          echo "Exit code: $exit_code"
          if [ $exit_code -ne 0 ]; then
            echo "Detected uncommitted changes after building. Please run 'npm run build' and commit the changes."
            exit 1
          fi
